<!-- templates/schedule/by_date.html -->


{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h3>{{ selected_date.strftime('%Y年%m月%d日') }} の工程予定</h3>

  <!-- ① 更新フォーム -->
  <form method="POST">
    {% for s in schedules %}
    <div class="card my-3">
      <div class="card-body">
        <h5 class="card-title">{{ s.company.company_name }}</h5>

        <!-- 担当者 -->
        <div class="mb-2">
          <strong>担当者:</strong>
          {% if s.company_id == current_user.id %}
            <input
              type="text"
              name="person_in_charge_{{ s.id }}"
              value="{{ s.person_in_charge }}"
              class="form-control"
            >
          {% else %}
            {{ s.person_in_charge or "未設定" }}
          {% endif %}
        </div>

        <!-- 時間帯 -->
        <div class="mb-2">
          <strong>時間帯:</strong>
          {% if s.company_id == current_user.id %}
            <select name="time_slot_{{ s.id }}" class="form-control">
              {% for slot in ['午前','午後','終日','夜'] %}
                <option value="{{ slot }}" {% if slot == s.time_slot %}selected{% endif %}>
                  {{ slot }}
                </option>
              {% endfor %}
            </select>
          {% else %}
            {{ s.time_slot }}
          {% endif %}
        </div>

        <!-- 作業内容 -->
        <div class="mb-2">
          <strong>作業内容:</strong>
          {% if s.company_id == current_user.id %}
            <input
              type="text"
              name="task_name_{{ s.id }}"
              value="{{ s.task_name }}"
              class="form-control"
            >
          {% else %}
            {{ s.task_name }}
          {% endif %}
        </div>

        <!-- コメント -->
        <div class="mb-2">
          <strong>コメント:</strong>
          {% if s.company_id == current_user.id %}
            <textarea
              name="comment_{{ s.id }}"
              class="form-control"
              rows="2"
            >{{ s.comment }}</textarea>
          {% else %}
            {{ s.comment or "なし" }}
          {% endif %}
        </div>

        <!-- 依頼元担当者 -->
        <div class="mb-2">
          <label>依頼元担当者:</label>
          {% if current_user.company_name == s.company.company_name %}
            <input
              type="text"
              name="client_person_{{ s.id }}"
              value="{{ s.client_person or '' }}"
              class="form-control"
            >
          {% else %}
            <input
              type="text"
              value="{{ s.client_person or '未設定' }}"
              class="form-control bg-light"
              readonly
            >
          {% endif %}
        </div>

        <!-- 依頼元コメント -->
        <div class="mb-2">
          <label>依頼元コメント:</label>
          {% if current_user.company_name == s.company.company_name %}
            <textarea
              name="client_comment_{{ s.id }}"
              class="form-control"
              rows="2"
            >{{ s.client_comment or '' }}</textarea>
          {% else %}
            <textarea
              class="form-control bg-light"
              rows="2"
              readonly
            >{{ s.client_comment or 'なし' }}</textarea>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary">更新</button>
      <a href="{{ url_for('main.schedule_calendar') }}" class="btn btn-secondary">カレンダーに戻る</a>
    </div>
  </form>

  <!-- ② 削除フォーム（更新フォームとは別） -->
  {% for s in schedules %}
    {% if s.company_id == current_user.id %}
    <div class="card my-3">
      <div class="card-body">
       <h5 class="card-title">
       {{ s.date.strftime('%Y年%m月%d日') }} の「{{ s.task_name }}」を削除
        </h5>      </div>
      <div class="card-footer text-end">
        <form
          method="POST"
          action="{{ url_for('main.schedule_delete', id=s.id) }}"
          onsubmit="return confirm('本当に削除しますか？');"
        >
          <button type="submit" class="btn btn-danger btn-sm">🗑️ 削除</button>
        </form>
      </div>
    </div>
    {% endif %}
  {% endfor %}

  <!-- ③ 新規追加フォーム -->
  <h4 class="mt-5">🔰 新しい工程予定を追加</h4>
  <form method="POST" action="{{ url_for('main.schedule_add') }}">
    <div class="mb-3">
      <label>時間帯</label>
      <select name="time_slot" class="form-control" required>
        <option value="">— 選択 —</option>
        <option value="午前">午前</option>
        <option value="午後">午後</option>
        <option value="終日">終日</option>
        <option value="夜">夜</option>
      </select>
    </div>
    <div class="mb-3">
      <label>開始日</label>
      <input type="date" name="date" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>終了日</label>
      <input type="date" name="end_date" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>作業内容</label>
      <input type="text" name="task_name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>担当者</label>
      <input type="text" name="person_in_charge" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>現場名</label>
      <input type="text" name="site_name" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-success">追加</button>
  </form>
</div>
{% endblock %}
