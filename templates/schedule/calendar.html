<!-- templates/schedule/calendar.html -->
{% extends 'base.html' %}
{% block head %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <style>
    /* 折り返し／自動高さ */
    .fc .fc-daygrid-event {
      white-space: normal !important;
      height: auto !important;
    }
    .fc .fc-daygrid-event .fc-event-title {
      overflow-wrap: break-word;
    }
    /* 日曜・祝日の赤字は既存のまま */
  </style>
{% endblock %}

{% block content %}
  <h2>稲沢工場D棟 の工程表</h2>
  <div id="calendar"></div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/ja.global.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var holidayList = [ /* YYYY-MM-DD の祝日を入れる */ ];

      var calendar = new FullCalendar.Calendar(
        document.getElementById('calendar'),
        {
          locale: 'ja',
          initialView: 'dayGridMonth',
          headerToolbar: { left:'prev,next today', center:'title', right:'' },
          titleFormat: { year:'numeric', month:'numeric' },
          dayHeaderFormat: { weekday:'narrow' },
          buttonText: { today:'今日' },
          firstDay: 0,
          events: '/api/schedules',

          // 日付セルをクリック → 日付詳細ページ
          dateClick: info => {
            window.location.href = '/schedules/date/' + info.dateStr;
          },

          // イベントクリック → メモなら同様に詳細へ
          eventClick: info => {
            if(info.event.id.startsWith('memo-')){
              window.location.href = '/schedules/date/' + info.event.startStr;
            }
          },

          // ── ここでバーの見せ方をカスタマイズ ──
          eventContent: arg => {
            if(arg.event.id.startsWith('sch-')){
              // 略称のテキスト
              let div = document.createElement('div');
              div.textContent = arg.event.title;
              // ホバーで詳細タイトルを出す
              div.setAttribute('title', arg.event.extendedProps.fullTitle);
              return { domNodes: [ div ] };
            }
            // 背景メモは何も描画しない（背景色のみ）
            return { domNodes: [] };
          },

          // セル描画後に日曜や祝日へクラス追加
          dayCellDidMount: info => {
            let d = info.date, s = d.toISOString().slice(0,10);
            if(d.getDay()===0 || holidayList.includes(s)){
              info.el.classList.add('holiday');
            }
          }
        }
      );
      calendar.render();
    });
  </script>
{% endblock %}
